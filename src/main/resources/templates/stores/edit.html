<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout::base_header('店舗編集')}"></head>
<body>
<!-- ナビゲーションバー -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-store"></i> KidsPOS
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/stores">
                <i class="fas fa-store-alt"></i> 店舗管理
            </a>
            <a class="nav-link" href="/">
                <i class="fas fa-home"></i> ダッシュボード
            </a>
        </div>
    </div>
</nav>

<div class="main-container">
    <!-- Main Content -->
    <div class="container-wrapper">
        <div class="content-area">
            <div class="container-fluid mt-3">
                <div class="row">
                    <div class="col-12 col-md-8 col-lg-6 mx-auto">
                        <div class="card-modern">
                            <div class="card-body">
                                <h4 class="mb-4 text-center">
                                    <i class="fas fa-edit text-primary me-2"></i>
                                    店舗編集
                                </h4>
                                <form th:action="@{/stores/{id}/update(id=${store.id})}" method="post">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">店舗名 <span class="text-danger">*</span></label>
                                        <input id="name" name="name" type="text" class="form-control"
                                               th:value="${store.name}"
                                               required
                                               placeholder="店舗名を入力してください"
                                               maxlength="100"/>
                                        <div class="form-text">店舗を識別するための名前を入力してください</div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">プリンタIPアドレス</label>
                                        <div class="d-flex align-items-center gap-2">
                                            <input id="printerIp1" type="number" class="form-control text-center ip-input"
                                                   min="0" max="255" style="width: 70px;">
                                            <span>.</span>
                                            <input id="printerIp2" type="number" class="form-control text-center ip-input"
                                                   min="0" max="255" style="width: 70px;">
                                            <span>.</span>
                                            <input id="printerIp3" type="number" class="form-control text-center ip-input"
                                                   min="0" max="255" style="width: 70px;">
                                            <span>.</span>
                                            <input id="printerIp4" type="number" class="form-control text-center ip-input"
                                                   min="0" max="255" style="width: 70px;">
                                        </div>
                                        <input id="printerUri" name="printerUri" type="hidden" th:value="${store.printerUri}"/>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <a class="btn btn-secondary" href="/stores">
                                            <i class="fas fa-arrow-left"></i> キャンセル
                                        </a>
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-save"></i> 更新
                                        </button>
                                    </div>
                                </form>

                                <hr class="my-4">

                                <div class="text-center">
                                    <form th:action="@{/stores/{id}/delete(id=${store.id})}" method="post"
                                          onsubmit="return confirm('この店舗を削除してもよろしいですか？\n削除した店舗の売上データも削除される可能性があります。')">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i> この店舗を削除
                                        </button>
                                    </form>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        削除操作は取り消せません
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/validation.js"></script>
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    const ip1 = document.getElementById('printerIp1');
    const ip2 = document.getElementById('printerIp2');
    const ip3 = document.getElementById('printerIp3');
    const ip4 = document.getElementById('printerIp4');
    const printerUri = document.getElementById('printerUri');
    const form = document.querySelector('form[method="post"]');

    // 既存のIPアドレスから値を解析して設定
    const existingUri = /*[[${store.printerUri}]]*/ '';
    if (existingUri) {
        // IPアドレスのみの場合
        const ipMatch = existingUri.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
        if (ipMatch) {
            ip1.value = ipMatch[1];
            ip2.value = ipMatch[2];
            ip3.value = ipMatch[3];
            ip4.value = ipMatch[4];
        } else {
            // 旧形式（http://IP:port）の場合も対応
            const uriMatch = existingUri.match(/http:\/\/(\d+)\.(\d+)\.(\d+)\.(\d+)/);
            if (uriMatch) {
                ip1.value = uriMatch[1];
                ip2.value = uriMatch[2];
                ip3.value = uriMatch[3];
                ip4.value = uriMatch[4];
            }
        }
    }

    // IPアドレス自動フォーカス移動
    function setupAutoFocus(currentInput, nextInput) {
        currentInput.addEventListener('input', function(e) {
            const value = parseInt(this.value);
            if (this.value.length >= 3 || value >= 100) {
                if (nextInput) nextInput.focus();
            }
        });

        currentInput.addEventListener('keydown', function(e) {
            if (e.key === '.' && nextInput) {
                e.preventDefault();
                nextInput.focus();
            }
        });
    }

    setupAutoFocus(ip1, ip2);
    setupAutoFocus(ip2, ip3);
    setupAutoFocus(ip3, ip4);

    // フォーム送信時にURIを構築
    form.addEventListener('submit', function(e) {
        const ipParts = [ip1.value, ip2.value, ip3.value, ip4.value];
        const hasAnyIpValue = ipParts.some(part => part !== '');

        if (hasAnyIpValue) {
            // IPアドレスの一部が入力されている場合、全て必須
            const isValidIp = ipParts.every(part => part !== '' && parseInt(part) >= 0 && parseInt(part) <= 255);
            if (!isValidIp) {
                e.preventDefault();
                alert('IPアドレスを正しく入力してください（各欄に0-255の数値）');
                return;
            }

            const ipAddress = ipParts.join('.');
            printerUri.value = ipAddress;
        } else {
            // IPアドレスが未入力の場合は空文字列
            printerUri.value = '';
        }
    });
});
</script>
</body>
</html>